<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/styles.css">
    <title>Home - Wailing Well</title>
    <style>
        #toss-coin-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            height: 500px;
            background-color: transparent;
            border-radius: 10px;
            overflow: hidden;
        }
        .buttons { margin-top: 20px; }
    </style>
</head>
<body>
    <!-- Video Background -->
    <video autoplay muted loop id="video-background" poster="/static/images/well.webp">
        <source src="/static/videos/well.mp4" type="video/mp4">
        <!-- Fallback image in case the video cannot be loaded -->
        <img src="/static/images/well.webp" id="fallback-background" alt="Background Image">
    </video>

    <div class="container">
        <h1 class="top-aligned">Welcome, {{ username }}!</h1>
        <div id="toss-coin-container">
            <!-- 3D scene will render here -->
        </div>
        <div class="buttons">
            <button id="toss-coin-btn" class="btn">Toss the Coin</button>
            <a href="#" id="new-journal-btn" class="btn disabled-btn">New Journal Entry</a> <!-- Initially Disabled -->
            <a href="/journal/book" class="btn">View Journal Book</a>
            <a href="/" class="btn">Logout</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    <script>
        let scene, camera, renderer, coin;
        let tossing = false;
        let coinClicked = false;

        function init() {
            const container = document.getElementById('toss-coin-container');

            // Set up the scene
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 8;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); // Alpha for transparency
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setClearColor(0x000000, 0); // Set background color to transparent
            container.appendChild(renderer.domElement);

            // Add ambient light
            const ambientLight = new THREE.AmbientLight(0x404040); // soft white light
            scene.add(ambientLight);

            // Add a directional light
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5).normalize();
            scene.add(directionalLight);

            // Load the 3D coin model and its material
            const mtlLoader = new THREE.MTLLoader();
            mtlLoader.load('/static/images/coin.mtl', function(materials) {
                materials.preload();
                const objLoader = new THREE.OBJLoader();
                objLoader.setMaterials(materials);
                objLoader.load('/static/images/coin.obj', function(object) {
                    coin = object;
                    coin.scale.set(1.5, 1.5, 1.5); // Adjust scale to make it larger
                    coin.position.set(0, 3, 0); // Adjust position as needed

                    // Reset any existing rotation
                    coin.rotation.set(0.2, 10, 0); // Ensure the coin starts with no rotation



                    scene.add(coin);
                }, undefined, function(error) {
                    console.error('An error happened', error);
                });
            });

            // Attach event listener to the button
            document.getElementById('toss-coin-btn').addEventListener('click', onCoinClick);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);

            if (coin) {
                // Idle spinning
                if (!coinClicked) {
                    coin.rotation.y += 0.02; // Spin the coin on Y-axis while idle
                }

                // Coin fall animation
                if (tossing && coin.position.y > -10) {
                    coin.position.y -= 0.1;
                    coin.rotation.x += 0.2; // Add a bit of rotation as it falls

                    if (coin.position.y <= -10) {
                        scene.remove(coin); // Remove the coin from the scene when it goes off screen
                        enableNewJournalButton(); // Enable the New Journal Entry button
                        tossing = false;
                    }
                }
            }

            renderer.render(scene, camera);
        }

        function onCoinClick() {
            if (!coinClicked) {
                coinClicked = true;
                tossCoin();
            }
        }

        function tossCoin() {
            tossing = true;
            const targetPosition = new THREE.Vector3(0, -2, 0); // The position where the well is located
            const startPosition = new THREE.Vector3(0, 4, 0); // Starting position of the coin at the corner
            const duration = 2; // Duration of the animation in seconds
            const startTime = Date.now();

            if (coin) {
                coin.position.copy(startPosition);
                coin.scale.set(1.5, 1.5, 1.5); // Starting scale

                function animateCoin() {
                    const elapsedTime = (Date.now() - startTime) / 1000;
                    const t = Math.min(elapsedTime / duration, 1); // Normalize time to [0, 1]

                    // Interpolate position
                    coin.position.lerpVectors(startPosition, targetPosition, t);

                    // Interpolate scale (make it smaller as it moves)
                    const scaleValue = THREE.MathUtils.lerp(1.5, 0.1, t);
                    coin.scale.set(scaleValue, scaleValue, scaleValue);

                    // Rotate the coin while it moves
                    coin.rotation.y += 0.1; // Add rotation on the Y-axis

                    // Check if the animation is complete
                    if (t < 1) {
                        requestAnimationFrame(animateCoin);
                    } else {
                        scene.remove(coin); // Remove the coin when the animation is complete
                        enableNewJournalButton(); // Enable the New Journal Entry button
                    }
                }

                animateCoin();
            }
        }


        function enableNewJournalButton() {
            const journalBtn = document.getElementById('new-journal-btn');
            journalBtn.classList.remove('disabled-btn'); // Remove the disabled class
            journalBtn.href = '/journal'; // Set the correct link
            journalBtn.style.cursor = 'pointer'; // Change cursor to pointer
            journalBtn.addEventListener('click', function() {
                window.location.href = '/journal'; // Redirect to journal entry page
            });
        }

        window.onload = init;
    </script>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.getElementById('video-background');
            video.playbackRate = 0.3; // Adjust this value to make the video slower or faster
        });
    </script>
</body>
</html>
